name: "ðŸ¤– iFlow CLI Automation"

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, reopened, synchronize]
  pull_request_review_comment:
    types: [created]
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1-5'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Optional: issue number to implement'
        required: false
        type: number
      pr_number:
        description: 'Optional: pull request number to review'
        required: false
        type: number
      trigger_apply:
        description: 'Manually trigger apply changes for a PR'
        required: false
        type: number

jobs:
  solve_issue:
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@iflow-cli /solve')) ||
      (github.event_name == 'workflow_dispatch' && inputs.issue_number)
    concurrency:
      group: ${{ github.workflow }}-issue-${{ github.event.issue.number || inputs.issue_number || github.run_id }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: "Solve Issue"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title || 'manual' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## ROLE
            You are an AI developer + project manager agent that acts through the local repository and CLIs (git, gh, wrangler). Act autonomously to implement, test, document, and open PRs for issues. Never leak secrets.

            ## CONTEXT
            - ISSUE_TITLE: ${{ env.ISSUE_TITLE }}
            - ISSUE_BODY: ${{ env.ISSUE_BODY }}
            - ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
            - REPOSITORY: ${{ env.REPOSITORY }}

            ## PRIMARY OBJECTIVE
            Fully handle the issue end-to-end (triage â†’ implement â†’ PR â†’ report).  
            If no code change needed, comment, label, and close appropriately.

            ## STEPS
            1. Check environment & labels  
               - Ensure clean repo: `git status --porcelain`  
               - List labels: `gh label list`  
               - Apply suitable labels (kind/priority) and remove `status/needs-triage` if any  
               - Comment short plan of action on issue  

            2. If no implementation required  
               - Comment reason and close or link duplicates  

            3. If implementation required  
               a. Create branch: `git checkout -b iflow/issue-${ISSUE_NUMBER}`  
               b. Identify relevant files and post a short plan to issue  
               c. Implement focused changes (no heavy CI/build)  
               d. Run lightweight checks (lint/format if available)  
               e. Commit:  
                  `git commit -am "fix(issue-${ISSUE_NUMBER}): short summary â€” Closes #${ISSUE_NUMBER}"`  
               f. Push & open PR:  
                  `gh pr create --fill --title "fix(issue-${ISSUE_NUMBER}): short summary" --body "Automated implementation for #${ISSUE_NUMBER}"`

            4. Post result summary  
               - Comment on issue with branch, PR link, and short summary  
               - Include JSON summary as code block:  
                 {
                   "issue": ${{ env.ISSUE_NUMBER }},
                   "branch": "iflow/issue-${{ env.ISSUE_NUMBER }}",
                   "pr_url": "<PR_URL>",
                   "actions": ["triage","implement","push","pr_opened"],
                   "notes": "done"
                 }
               - Update labels: remove `status/in-progress`, add `status/review` or `status/done`

            5. Error handling  
               - On any failure, revert: `git reset --hard HEAD && git checkout main`
               - Comment failure details with next steps  

            ## RULES
            * Never print or log secrets  
            * Modify only necessary files  
            * Keep changes small, atomic, and maintainable  
            * Prefer clarity over complexity  
            * End with human summary + JSON report

  review_pr:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@iflow-cli /review')) ||
      (github.event_name == 'workflow_dispatch' && inputs.pr_number)
    concurrency:
      group: ${{ github.workflow }}-pr-${{ github.event.pull_request.number || inputs.pr_number || github.run_id }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Review PR"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
          BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
          HEAD_REF: ${{ github.event.pull_request.head.ref || '' }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Role
            AI code reviewer analyzing full PR context.

            ## Tasks
            1. Checkout PR: `gh pr checkout $PR_NUMBER`
            2. Inspect changes: `git diff $BASE_REF...$HEAD_REF`
            3. Fetch all discussions and prior reviews
            4. Post a comprehensive review covering:
               - Security risks
               - Performance implications
               - Code quality and maintainability
               - Unaddressed reviewer feedback

  apply_pr_changes:
    if: |
      (github.event_name == 'pull_request_review_comment' &&
       (contains(github.event.comment.body, '@iflow-cli /apply') ||
        github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'workflow_dispatch' && inputs.trigger_apply)
    concurrency:
      group: ${{ github.workflow }}-apply-${{ github.event.pull_request.number || inputs.trigger_apply || github.run_id }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Apply Changes from Full Discussion"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.trigger_apply }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Role
            AI maintainer applying changes from entire PR discussion.

            ## Tasks
            1. Gather all PR comments and reviews  
            2. Apply small, concrete feedback (<20 lines) that has clear consensus  
            3. Commit as "Apply feedback from comment [ID]"  
            4. Push back to PR branch  
            5. Skip abstract or design-only discussions  

            ## Rules
            * Never modify CI/workflow/security configs  
            * Preserve authorship  
            * End with short summary comment

  update_docs:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: "Update Documentation"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REPOSITORY: ${{ github.repository }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '3600'
          debug: 'false'
          prompt: |
            ## Role
            AI documentation specialist triggered by main branch updates.

            ## Tasks
            1. Analyze last commit message  
            2. If it affects user-facing features, update README/docs/examples  
            3. Commit and open PR with "docs: update for <commit>"  

  maintenance:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: "Repository Maintenance"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REPOSITORY: ${{ github.repository }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '10800'
          debug: 'false'
          prompt: |
            ## Role
            AI security & maintenance agent.

            ## Tasks
            1. Detect outdated dependencies and vulnerabilities  
            2. Apply safe patch-level updates only  
            3. Commit minimal fixes and open PR with changelog  

  notify_failure:
    if: always() && (failure() || cancelled())
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            if (process.env.GITHUB_RUN_ATTEMPT === '1') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Workflow Failure: ${{ github.workflow }}`,
                body: `Failed run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
                labels: ['automation-error']
              });
            }
        env:
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
