name: The Creator & Solver (Push)

on:
  workflow_dispatch:
  push:
    branches: [main, master]

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: creator-solver-${{ github.ref }}
  cancel-in-progress: false

jobs:
  creator_solver:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install OpenCode CLI
        run: curl -fsSL https://opencode.ai/install.sh | sh

      - name: Analyze ecosystem
        id: analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -Eeuo pipefail
          ISSUE_COUNT=$(gh issue list --state open --json number | jq length)
          echo "count=$ISSUE_COUNT" >> "$GITHUB_OUTPUT"

      - name: Creator mode (issues < 10)
        if: ${{ fromJSON(steps.analysis.outputs.count) < 10 }}
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -Eeuo pipefail
          opencode run \
            --model opencode/gpt-5-nano \
            --prompt "Analyze the repo for TODOs, missing docs, and user stories, then create new GitHub issues that are not duplicates. Use gh issue create with clear acceptance criteria." \
            --share false

      - name: Solver mode (issues >= 10)
        if: ${{ fromJSON(steps.analysis.outputs.count) >= 10 }}
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -Eeuo pipefail

          issue_pick() {
            gh issue list --label "$1" --state open --limit 1 --json number --jq '.[0].number' 2>/dev/null || true
          }

          ISSUE_NUM=$(issue_pick critical)
          if [ -z "${ISSUE_NUM}" ] || [ "${ISSUE_NUM}" = "null" ]; then
            ISSUE_NUM=$(issue_pick high)
          fi
          if [ -z "${ISSUE_NUM}" ] || [ "${ISSUE_NUM}" = "null" ]; then
            ISSUE_NUM=$(gh issue list --state open --limit 1 --json number --jq '.[0].number')
          fi

          if [ -z "${ISSUE_NUM}" ] || [ "${ISSUE_NUM}" = "null" ]; then
            echo "No open issues found; exiting."
            exit 0
          fi

          git config user.name "OpenCode Bot"
          git config user.email "bot@opencode.ai"

          BRANCH="fix/issue-${ISSUE_NUM}"
          git checkout -B "$BRANCH"

          opencode run \
            --model opencode/big-pickle \
            --prompt "Implement the solution for issue #$ISSUE_NUM. Update code, add/adjust tests, and ensure lint/build pass. Commit changes." \
            --share false

          git add -A
          git commit -m "Fix: Issue #$ISSUE_NUM" || true
          git push -u origin "$BRANCH"

          gh pr create \
            --title "Fix: Issue #$ISSUE_NUM" \
            --body "Resolves #$ISSUE_NUM. Auto-generated by OpenCode Solver." \
            --head "$BRANCH" \
            --base main || true
