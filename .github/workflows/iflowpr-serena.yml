name: iFlow Serena Auto Fix PR

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number (opsional, kosong = auto-select PR)"
        required: false
        type: string
      custom_prompt:
        description: "Instruksi tambahan untuk iFlow/Serena (opsional)"
        required: false
        type: string
  schedule:
    # contoh: jalan tiap hari jam 00:00 Asia/Jakarta (17:00 UTC hari sebelumnya)
    - cron: "0 17 * * *"

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

concurrency:
  group: "${{ github.workflow }}-${{ github.event.pull_request.number || github.head_ref || github.ref }}"
  cancel-in-progress: true

jobs:
  # STEP 2 – Build cepat, tanpa pakai token iFlow.
  build:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      build_result: ${{ steps.set_result.outputs.result }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Run CI build and tests
        id: run_build
        continue-on-error: true
        env:
          CI: true
        shell: bash
        run: |
          set -o pipefail

          run_ci() {
            if [ ! -f package.json ]; then
              echo "No package.json found. Nothing to build."
              return 0
            fi

            has_script() {
              node -e "const s=require('./package.json').scripts || {}; process.exit(Object.prototype.hasOwnProperty.call(s, '$1') ? 0 : 1);"
            }

            if [ -f pnpm-lock.yaml ]; then
              echo "Using pnpm"
              corepack enable
              pnpm install --frozen-lockfile

              if has_script lint; then pnpm run lint; fi
              if has_script test; then pnpm run test; fi
              if has_script build; then pnpm run build; fi

            elif [ -f yarn.lock ]; then
              echo "Using yarn"
              corepack enable
              yarn install --frozen-lockfile

              if has_script lint; then yarn run lint; fi
              if has_script test; then yarn run test; fi
              if has_script build; then yarn run build; fi

            else
              echo "Using npm"
              if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
                npm ci
              else
                npm install
              fi

              if has_script lint; then npm run lint; fi
              if has_script test; then npm test; fi
              if has_script build; then npm run build; fi
            fi
          }

          run_ci 2>&1 | tee build.log
          exit_code=${PIPESTATUS[0]}
          exit $exit_code

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: ignore

      - name: Set build result
        id: set_result
        run: |
          if [ "${{ steps.run_build.outcome }}" = "failure" ]; then
            echo "result=failure" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "result=success" >> "$GITHUB_OUTPUT"
          fi

  # STEP 3–7 – Auto-fix dengan iFlow + Serena.
  autofix:
    # TIDAK pakai `needs:` lagi, supaya workflow_dispatch / schedule bisa jalan.
    runs-on: ubuntu-latest

    # Logika:
    # - PR event: hanya jalan kalau job build tadi gagal
    # - workflow_dispatch / schedule: selalu jalan
    if: >
      (github.event_name == 'pull_request' &&
       needs.build.result == 'failure') ||
      (github.event_name != 'pull_request')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref }}
          persist-credentials: true

      - name: Download build log (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: build-log
          path: ./artifacts

      - name: Run iFlow CLI with Serena auto-fix
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

          REPOSITORY: ${{ github.repository }}

          PR_NUMBER: ${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.event.inputs.pr_number || '' }}
          PR_TITLE: ${{ github.event_name == 'pull_request' && github.event.pull_request.title || '' }}
          PR_BODY: ${{ github.event_name == 'pull_request' && github.event.pull_request.body || '' }}
          PR_HEAD_REF: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || '' }}
          PR_BASE_REF: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref || '' }}

          CUSTOM_PROMPT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.custom_prompt || '' }}
          BUILD_LOG_PATH: ${{ github.event_name == 'pull_request' && 'artifacts/build.log' || '' }}

        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          model: "Qwen3-Coder"
          timeout: "3600"
          debug: "true"

          settings_json: |
            {
              "selectedAuthType": "iflow",
              "apiKey": "${{ secrets.IFLOW_API_KEY }}",
              "baseUrl": "https://apis.iflow.cn/v1",
              "modelName": "Qwen3-Coder",
              "searchApiKey": "${{ secrets.IFLOW_API_KEY }}",
              "mcpServers": {
                "serena": {
                  "command": "uvx",
                  "args": [
                    "--from",
                    "git+https://github.com/oraios/serena",
                    "serena",
                    "start-mcp-server",
                    "--context",
                    "ide-assistant",
                    "--project",
                    "."
                  ]
                }
              }
            }

          prompt: |
            You are an autonomous coding agent running inside GitHub Actions for the repository $REPOSITORY.
            Your goal is to make a selected pull request "green" (all CI checks passing) and mergeable, while minimizing iFlow token usage.
            You have access to:
            - GitHub CLI (gh) authenticated with $GITHUB_TOKEN
            - The local git checkout of the repo
            - Serena MCP server via @serena
            - Node.js tooling and shell

            ## PR selection
            - If $PR_NUMBER is non-empty, work on that PR.
            - Otherwise:
              - List open PRs: gh pr list --state open --json number,title,headRefName,baseRefName,mergeStateStatus
              - Prefer PRs with failing checks or mergeStateStatus not clean.
              - If nothing to fix, exit.

            ## Context
            - For PR N:
              - gh pr view N --json title,body,author,headRefName,baseRefName,files,commits,reviews,comments,reviewThreads
            - Use $PR_TITLE, $PR_BODY when available.

            ## Build failure
            - If $BUILD_LOG_PATH is non-empty and exists:
              - Read the file once and summarize the root cause.
            - Else:
              - Detect package manager (pnpm / yarn / npm) and scripts (lint / test / build).
              - Run install + lint/test/build once to obtain a build log.
              - If build passes, do nothing and exit.

            ## Fix using Serena (@serena)
            - Use Serena for:
              - Finding files and symbols (find_file, find_symbol, get_symbols_overview, find_referencing_symbols).
              - Reading only relevant regions.
              - Applying minimal edits (replace_symbol_body, insert_before_symbol, replace_lines, etc.).
            - Always tie each change to a specific error from the build log.
            - Keep changes as local and minimal as possible.

            ## Re-run tests
            - After edits, re-run the same build/test command.
            - Iterate a few times until green or clearly stuck.

            ## Commit & push
            - Configure git:
              - git config user.name "iflow-bot"
              - git config user.email "iflow-bot@users.noreply.github.com"
            - Ensure you are on the PR branch (gh pr checkout N if needed).
            - Commit only intended changes and push.

            ## Merge / auto-merge
            - Prefer:
              - gh pr merge --auto --merge N
            - If not possible but all required checks are green:
              - gh pr merge --merge N
            - If branch protection prevents merge, leave PR with fixes pushed and exit.

            ## Custom instructions
            - If $CUSTOM_PROMPT is non-empty, follow it as long as it doesn't violate safety rules.

            Use @serena heavily to keep context small and token usage low.

