name: "?? devin"

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  gather_data:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch GitHub Actions run history
        run: |
          mkdir -p intel
          gh run list --limit 100 --json number,workflowName,conclusion,createdAt,startedAt,updatedAt,status > intel/gha_runs.json
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

      - name: Fetch recent open issues
        run: |
          gh issue list --state open --limit 200 --json number,title,labels,createdAt,updatedAt > intel/open_issues.json
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Fetch recent PR history
        run: |
          gh pr list --state all --limit 200 --json number,title,mergedAt,createdAt,closedAt,author > intel/recent_prs.json
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Upload collected data
        uses: actions/upload-artifact@v4
        with:
          name: repo-intel-data-${{ github.run_id }}
          path: intel/

  analyse_and_create_issues:
    needs: gather_data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download data artifacts
        uses: actions/download-artifact@v4
        with:
          name: repo-intel-data-${{ github.run_id }}
          path: ./intel

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Run OpenCode1
        id: run_devin
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
            ## ROLE  
            You are an autonomous GitHub repository intelligence agent with write-access.

            ## CONTEXT  
            - Repository: ${{ github.repository }}  
            - CI/CD runs data: ./intel/gha_runs.json  
            - Open issues data: ./intel/open_issues.json  
            - PR history data: ./intel/recent_prs.json  
            - Full repository code base is checked-out and available for deep analysis

            ## TASKS  
            1. Deeply analyze the codebase: modules, dependencies, documentation, test coverage gaps, duplication, naming inconsistencies.  
            2. Analyze CI/CD logs: identify jobs with frequent failures, long durations (>10 minutes), reruns, unstable workflows.  
            3. Analyze issue/PR history: stale issues (open >60 days), PRs closed without merge, recurring bug patterns.  
            4. Generate findings:  
               - Bugs/inefficiencies (with description, location, impact)  
               - Improvement opportunities (with gap and suggestion)  
               - Feature ideas (at least two) with value proposition, rough implementation steps, estimated effort/impact  
            5. Select 1 most important from findings and  **create a GitHub Issue** immediately.  
               - use `gh issue create --title "<Issue Title>" --body "<Issue body>" --label "kind/bug,priority/high"` (or appropriate labels)  
               - Category label must be one of `kind/bug`, `kind/enhancement`, `kind/documentation`, `kind/architecture`  
               - Priority label must be one of `priority/critical`, `priority/high`, `priority/medium`, `priority/low`  
            6. For improvement requiring workflow/config change: output unified-diff snippet targeting `.github/workflows/` or config files and commit or open PR if safe.  
            7. Self-improvement plan: propose what additional data you will collect next time, what thresholds to adjust, how you will refine your prompt or analysis logic, save to `intel/self_improvement_plan.md`.

            ## RULES  
            - Do not expose or log any secrets.  
            - All code changes (issue creation, patches) must be small, atomic, maintainable.  
            - When creating issues: ensure labels exist or propose their creation in the issue body.  
            - Use `gh issue create` or `gh pr create` commands within the agent to perform creations.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false \
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

      - name: Save self-improvement plan as artifact
        run: |
          if [ -f intel/self_improvement_plan.md ]; then
            echo "Uploading self-improvement plan..."
            gh release create "self-improvement-${{ github.run_id }}" intel/self_improvement_plan.md --draft --notes "Self-improvement plan generated by iFlow agent"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
