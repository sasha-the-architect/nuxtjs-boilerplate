name: "Auto-Update PRs"

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]
  schedule:
    - cron: '0 * * * *'
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-update-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================
  # 1) Auto-update PR on activity (non-fork)
  # ============================================================
  auto_update_event:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Fork Check
        id: forkcheck
        run: echo "fork=${{ github.event.pull_request.head.repo.fork }}" >> "$GITHUB_OUTPUT"

      - name: Notify Fork Users
        if: steps.forkcheck.outputs.fork == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ⚠️ **Fork Detected**
            Automatic updates are disabled for forks for security. Please rebase manually:
            ```bash
            git fetch upstream
            git rebase upstream/${{ github.event.pull_request.base.ref }}
            git push --force-with-lease
            ```

      - name: Checkout PR
        if: steps.forkcheck.outputs.fork != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Rebase & Push
        if: steps.forkcheck.outputs.fork != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/${{ github.repository }}.git
          git fetch upstream ${{ github.event.pull_request.base.ref }}
          git rebase upstream/${{ github.event.pull_request.base.ref }}
          git push --force-with-lease

  # ============================================================
  # 2) Scheduled Update for All PRs
  # ============================================================
  list_open_prs:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.collect.outputs.matrix }}
    steps:
      - name: Collect PRs
        id: collect
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.paginate(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            const valid = prs
              .filter(pr => !pr.head.repo.fork && !pr.draft)
              .map(pr => ({
                number: pr.number,
                head_ref: pr.head.ref,
                repo: pr.head.repo.full_name,
                base: pr.base.ref
              }));
            core.setOutput('matrix', JSON.stringify(valid.length ? valid : [{number: 0}]));

  rebase_scheduled:
    needs: list_open_prs
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pr: ${{ fromJson(needs.list_open_prs.outputs.matrix) }}
    steps:
      - name: Update PR #${{ matrix.pr.number }}
        if: matrix.pr.number != 0
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.pr.repo }}
          ref: ${{ matrix.pr.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Execute Rebase
        if: matrix.pr.number != 0
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/${{ github.repository }}.git
          git fetch upstream ${{ matrix.pr.base }}
          git rebase upstream/${{ matrix.pr.base }}
          git push --force-with-lease

  # ============================================================
  # 3) Manual Trigger via Comment
  # ============================================================
  comment_trigger:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && startsWith(github.event.comment.body, '/update')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR Details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              head_ref: pr.head.ref,
              repo: pr.head.repo.full_name,
              fork: pr.head.repo.fork,
              base: pr.base.ref
            }
      
      - name: Perform Update
        if: fromJson(steps.pr.outputs.result).fork == false
        uses: actions/checkout@v4
        with:
          repository: ${{ fromJson(steps.pr.outputs.result).repo }}
          ref: ${{ fromJson(steps.pr.outputs.result).head_ref }}
          fetch-depth: 0
      
      - name: Rebase
        if: fromJson(steps.pr.outputs.result).fork == false
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/${{ github.repository }}.git
          git fetch upstream ${{ fromJson(steps.pr.outputs.result).base }}
          git rebase upstream/${{ fromJson(steps.pr.outputs.result).base }}
          git push --force-with-lease
