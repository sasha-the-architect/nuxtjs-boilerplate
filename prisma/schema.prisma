generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model AnalyticsEvent {
  id         String    @id @default(cuid())
  type       String
  resourceId String?
  category   String?
  url        String?
  userAgent  String?
  ip         String?
  timestamp  DateTime
  properties String?
  deletedAt  DateTime?

  @@index([timestamp])
  @@index([resourceId])
  @@index([type])
  @@index([ip])
  @@index([timestamp, type])
  @@index([timestamp, resourceId])
  @@index([resourceId, type])
  @@index([ip, timestamp])
  @@index([category, timestamp])
  @@index([deletedAt])
  @@index([resourceId, type, timestamp, deletedAt])
  @@index([timestamp, deletedAt])
  @@index([ip, timestamp, deletedAt])
}

model Webhook {
  id        String    @id @default(cuid())
  url       String
  secret    String?
  active    Boolean   @default(true)
  events    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([active])
  @@index([deletedAt])
  @@index([active, deletedAt])
  @@index([url])
}

model WebhookDelivery {
  id             String    @id @default(cuid())
  webhookId      String
  event          String
  payload        String
  status         String    @default("pending")
  statusCode     Int?
  responseBody   String?
  errorMessage   String?
  attemptCount   Int       @default(1)
  idempotencyKey String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  @@index([webhookId])
  @@index([idempotencyKey])
  @@index([status])
  @@index([createdAt])
  @@index([webhookId, status])
  @@index([deletedAt])
}

model WebhookQueue {
  id           String    @id @default(cuid())
  webhookId    String
  event        String
  payload      String
  priority     Int       @default(0)
  retryCount   Int       @default(0)
  maxRetries   Int       @default(3)
  scheduledFor DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  @@index([scheduledFor])
  @@index([priority, scheduledFor])
  @@index([webhookId])
  @@index([deletedAt])
}

model DeadLetterWebhook {
  id               String    @id @default(cuid())
  webhookId        String
  event            String
  payload          String
  failureReason    String
  lastAttemptAt    DateTime  @default(now())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deliveryAttempts String
  deletedAt        DateTime?

  @@index([createdAt])
  @@index([webhookId])
  @@index([deletedAt])
}

model ApiKey {
  id          String    @id @default(cuid())
  key         String    @unique
  userId      String?
  name        String
  permissions String
  active      Boolean   @default(true)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([key])
  @@index([userId])
  @@index([active])
  @@index([expiresAt])
  @@index([deletedAt])
  @@index([key, deletedAt, active])
}

model IdempotencyKey {
  id         String    @id @default(cuid())
  key        String    @unique
  webhookId  String?
  deliveryId String?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  @@index([key])
  @@index([webhookId])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([deletedAt])
}
